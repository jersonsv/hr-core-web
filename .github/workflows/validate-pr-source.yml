name: Validate GitFlow PR Rules
on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  validate-gitflow:
    runs-on: ubuntu-latest
    name: Validate GitFlow PR Rules

    steps:
      - name: Get PR Info & Validate GitFlow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const base = pr.base.ref;
            const head = pr.head.ref;

            console.log(`🎯 Validating: ${head} → ${base}`);

            // Helper functions
            const isFeature = (branch) => /^(feature|feat)\//.test(branch);
            const isHotfix = (branch) => /^(hotfix|fix)\//.test(branch);

            const showError = (msg, solution) => {
              console.log(`❌ ${msg}`);
              console.log(`🔧 ${solution}`);
              core.setFailed(msg);
            };

            // GitFlow Rules
            if (base === 'main') {
              if (head !== 'develop') {
                showError(
                  `PRs to 'main' only from 'develop'. Current: ${head}`,
                  `Create: ${head} → develop → main`
                );
                return;
              }
              console.log('✅ Valid: develop → main');
              
            } else if (base === 'develop') {
              if (!isFeature(head) && !isHotfix(head)) {
                showError(
                  `PRs to 'develop' need feature/* or hotfix/* branches. Current: ${head}`,
                  `Rename to: feature/${head} or hotfix/${head}`
                );
                return;
              }
              console.log(`✅ Valid: ${head} → develop`);
              
            } else {
              console.log(`✅ PR to '${base}' - no GitFlow restrictions`);
            }

            console.log('🎉 GitFlow validation passed!');
